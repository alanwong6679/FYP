<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>General Schedule</title>
    <link rel="stylesheet" href="navbar.css">
    <style>
        body { font-family: 'Roboto', sans-serif; margin: 0; padding: 0; background: #f4f4f9; color: #333; }
        header { background: #007dc5; padding: 20px; color: #fff; text-align: center; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 8px; }
        h1, h2, h3 { color: #007dc5; text-align: center; }
        .route-option { border: 1px solid #ccc; padding: 15px; margin: 10px 0; cursor: pointer; border-radius: 8px; transition: background 0.3s; }
        .route-option:hover { background: #f0f0f0; }
        .schedule-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .schedule-table th, .schedule-table td { padding: 8px; border: 1px solid #ddd; text-align: left; }
        .schedule-table th { background: #f2f2f2; }
        .route-details { display: none; margin-left: 20px; padding: 10px; }
        .stop-list { list-style: none; padding: 0; }
        .stop-list li { padding: 8px 0; border-bottom: 1px solid #eee; }
        .boarding-stop, .alighting-stop { font-weight: bold; animation: pulse 1.5s infinite; }
        .boarding-stop { color: blue; }
        .alighting-stop { color: red; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); }
        .modal-content { background: #fff; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; max-height: 70vh; overflow-y: auto; }
        .news-item { margin-bottom: 10px; padding: 10px; border-bottom: 1px solid #ccc; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }
        .language-switch { position: absolute; top: 10px; right: 10px; display: flex; gap: 10px; }
        .source-reference { margin-top: 20px; font-size: 12px; color: gray; text-align: center; }
    </style>
</head>
<body>
    <header><h1>MTR Schedule</h1></header>
    <div class="container">
        <div id="route-options"></div>
        <div id="schedule" class="schedule-detail"></div>
    </div>
    <div class="news-icon"></div>
    <div id="newsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="toggleModal()">×</span>
            <div class="language-switch"><button id="btnChinese">中文</button><button id="btnEnglish">English</button></div>
            <div id="newsContent">Loading...</div>
            <div class="source-reference">Source: RTHK</div>
        </div>
    </div>
    <script src="stations.js"></script>
    <script src="navbar.js"></script>
    <script src="RTHK.js"></script>
    <script>
        const lineNames = {"AEL": "Airport Express Line <span style='display:inline-block;width:20px;height:10px;background:#00888A;border-radius:5px'></span>","TCL": "Tung Chung Line <span style='display:inline-block;width:20px;height:10px;background:#F7943E;border-radius:5px'></span>","TML": "Tuen Ma Line <span style='display:inline-block;width:20px;height:10px;background:#923011;border-radius:5px'></span>","TKL": "Tseung Kwan O Line <span style='display:inline-block;width:20px;height:10px;background:#7D499D;border-radius:5px'></span>","EAL": "East Rail Line <span style='display:inline-block;width:20px;height:10px;background:#53B7E8;border-radius:5px'></span>","SIL": "South Island Line <span style='display:inline-block;width:20px;height:10px;background:#BAC429;border-radius:5px'></span>","TWL": "Tsuen Wan Line <span style='display:inline-block;width:20px;height:10px;background:#ED1D24;border-radius:5px'></span>","ISL": "Island Line <span style='display:inline-block;width:20px;height:10px;background:#007DC5;border-radius:5px'></span>","KTL": "Kwun Tong Line <span style='display:inline-block;width:20px;height:10px;background:#00AB4E;border-radius:5px'></span>"};
        const [allRoutes, allStops, routeStopsMap] = [JSON.parse(localStorage.getItem('allRoutes')) || [], JSON.parse(localStorage.getItem('allStops')) || [], JSON.parse(localStorage.getItem('routeStopsMap')) || []];
        let originalContent = '';

        const haversineDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371000, dLat = (lat2 - lat1) * Math.PI / 180, dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        };

        const getStations = () => [...new Set(Object.values(lines).flat().map(s => s.value))].map(v => Object.values(lines).flat().find(s => s.value === v));
        const getStationFullName = code => Object.values(lines).flat().find(s => s.value === code)?.text || code;
        const findNearbyStops = (station, maxDistance = 1000) => allStops.filter(s => s.lat && s.long && station.lat && station.long && haversineDistance(parseFloat(s.lat), parseFloat(s.long), station.lat, station.long) <= maxDistance);
        const findNearestMTR = (busStop, mtrStations) => {
            if (!busStop || !busStop.lat || !busStop.long) return { station: null, distance: NaN };
            return mtrStations.reduce((acc, station) => {
                if (!station.lat || !station.long) return acc;
                const distance = haversineDistance(parseFloat(busStop.lat), parseFloat(busStop.long), parseFloat(station.lat), parseFloat(station.long));
                return !isNaN(distance) && distance < acc.distance ? { station, distance } : acc;
            }, { station: null, distance: Infinity });
        };

        window.onload = () => {
            const params = new URLSearchParams(window.location.search), [cs, ds, sbs, ebs] = [params.get('currentStation'), params.get('destinationStation'), params.get('startBusStop'), params.get('endBusStop')], stations = getStations();
            cs && ds ? fetchSchedule(cs, ds) : sbs && ebs ? fetchBusRoutes(sbs, ebs) : sbs && ds ? fetchBusToMTR(sbs, ds, stations) : cs && ebs ? fetchMTRToBus(cs, ebs, stations) : document.getElementById('schedule').innerHTML = '<div class="error">Invalid parameters.</div>';
            document.querySelector('.news-icon').onclick = fetchNewsContent;
            document.getElementById('btnChinese').onclick = () => document.getElementById('newsContent').innerHTML = originalContent || 'No news.';
        };

        const toggleModal = () => document.getElementById('newsModal').style.display = document.getElementById('newsModal').style.display === 'block' ? 'none' : 'block';
        const fetchNewsContent = () => fetch('https://programme.rthk.hk/channel/radio/trafficnews/index.php').then(r => r.text()).then(d => {
            originalContent = Array.from(new DOMParser().parseFromString(d, 'text/html').querySelectorAll('ul.dec > li.inner')).map(i => `<div class="news-item">${i.textContent.trim()}</div>`).join('') || 'No news.';
            document.getElementById('newsContent').innerHTML = originalContent;
            toggleModal();
        }).catch(e => console.error('News fetch error:', e));

        const fetchSchedule = async (cs, ds) => {
            try {
                const { error, schedules, bestRoute, alternativeRoutes } = await fetch('/fetch_schedule', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ currentStation: cs, destinationStation: ds }) }).then(r => r.json());
                if (error) throw new Error(error);
                displayRouteOptions(bestRoute, alternativeRoutes, schedules, cs, ds);
            } catch (e) {
                document.getElementById('schedule').innerHTML = `<div class="error">${e.message || 'Fetch failed'}</div>`;
            }
        };

        const displayRouteOptions = (best, alts, schedules, cs, ds) => {
            document.getElementById('route-options').innerHTML = [[best, 'Best Route'], ...alts.map((r, i) => [r, `Alternative Route ${i + 1}`])].map(([r, n]) => `
                <div class="route-option" onclick="displaySchedule('${JSON.stringify(schedules).replace(/"/g, '"')}', '${r.route.join()}', '${cs}', '${ds}')">
                    <strong>${n}:</strong> ${r.route.map(l => lineNames[l]).concat(r.interchanges.slice(-1).map(getStationFullName)).join(' → ')} (${r.interchangeCount} interchange${r.interchangeCount !== 1 ? 's' : ''})
                </div>`).join('');
        };

        const displaySchedule = (data, route, cs, ds) => {
            data = JSON.parse(data.replace(/"/g, '"'));
            document.getElementById('schedule').innerHTML = `<h2>From ${getStationFullName(cs)} to ${getStationFullName(ds)}</h2>` + route.split(',').map(line => `
                <h2>${lineNames[line]}</h2>
                <div><strong>Current Time:</strong> ${data[line]?.curr_time || '-'}<br><strong>System Time:</strong> ${data[line]?.sys_time || '-'}</div>
                <h3>UP Trains</h3><table class="schedule-table"><tr><th>Time</th><th>Platform</th><th>Destination</th><th>Sequence</th><th>Valid</th></tr>${data[line]?.up?.length ? data[line].up.map(t => `<tr><td>${t.time}</td><td>${t.plat}</td><td class="dest-cell" data-dest="${t.dest}">${t.dest}</td><td>${t.seq}</td><td>${t.valid}</td></tr>`).join('') : '<tr><td colspan="5">No UP trains</td></tr>'}</table>
                <h3>DOWN Trains</h3><table class="schedule-table"><tr><th>Time</th><th>Platform</th><th>Destination</th><th>Sequence</th><th>Valid</th></tr>${data[line]?.down?.length ? data[line].down.map(t => `<tr><td>${t.time}</td><td>${t.plat}</td><td class="dest-cell" data-dest="${t.dest}">${t.dest}</td><td>${t.seq}</td><td>${t.valid}</td></tr>`).join('') : '<tr><td colspan="5">No DOWN trains</td></tr>'}</table>
            `).join('');
            document.querySelectorAll('.dest-cell').forEach(c => c.innerText = getStationFullName(c.dataset.dest));
        };

        const fetchBusRoutes = (start, end) => {
            const [ss, es] = [allStops.find(s => s.stop === start), allStops.find(s => s.stop === end)];
            if (!ss || !es) return document.getElementById('schedule').innerHTML = '<p>Invalid bus stops.</p>';
            const routes = allRoutes.flatMap(r => ['outbound', 'inbound'].map(d => {
                const stops = routeStopsMap[`${r.route}-${d}`] || [], sm = findNearbyStops(ss).map(s => s.stop).filter(id => stops.includes(id));
                if (!sm.length) return null;
                const cs = sm.reduce((a, id) => haversineDistance(parseFloat(ss.lat), parseFloat(ss.long), parseFloat(allStops.find(s => s.stop === id).lat), parseFloat(allStops.find(s => s.stop === id).long)) < a[1] ? [id, haversineDistance(parseFloat(ss.lat), parseFloat(ss.long), parseFloat(allStops.find(s => s.stop === id).lat), parseFloat(allStops.find(s => s.stop === id).long))] : a, ['', Infinity])[0];
                const em = findNearbyStops(es).map(s => s.stop).filter(id => stops.indexOf(id) > stops.indexOf(cs));
                if (!em.length) return null;
                const ce = em.reduce((a, id) => haversineDistance(parseFloat(es.lat), parseFloat(es.long), parseFloat(allStops.find(s => s.stop === id).lat), parseFloat(allStops.find(s => s.stop === id).long)) < a[1] ? [id, haversineDistance(parseFloat(es.lat), parseFloat(es.long), parseFloat(allStops.find(s => s.stop === id).lat), parseFloat(allStops.find(s => s.stop === id).long))] : a, ['', Infinity])[0];
                return { route: r.route, direction: d, stops: stops.map(id => ({ id, name: allStops.find(s => s.stop === id)?.name_en || `Stop ${id}` })), boardingStop: cs, alightingStop: ce, boardingDistance: haversineDistance(parseFloat(ss.lat), parseFloat(ss.long), parseFloat(allStops.find(s => s.stop === cs).lat), parseFloat(allStops.find(s => s.stop === cs).long)), alightingDistance: haversineDistance(parseFloat(es.lat), parseFloat(es.long), parseFloat(allStops.find(s => s.stop === ce).lat), parseFloat(allStops.find(s => s.stop === ce).long)) };
            })).filter(r => r);
            window.currentRoutes = routes;
            document.getElementById('schedule').innerHTML = routes.length ? '<h3>Direct Bus Routes</h3>' + routes.map((r, i) => `
                <div class="route-option" id="route-summary-${i}" data-route="${r.route}" data-direction="${r.direction}" data-boarding-stop="${r.boardingStop}" onclick="toggleRouteDetails('route-details-${i}', this)">
                    <strong>Route ${r.route} (${r.direction})</strong> - ${r.stops.length - 1} stops<br>Walk ${Math.round(r.boardingDistance)}m to ${r.stops.find(s => s.id === r.boardingStop).name}, alight at ${r.stops.find(s => s.id === r.alightingStop).name} (${Math.round(r.alightingDistance)}m)
                </div>
                <div class="route-details" id="route-details-${i}">${r.stops.map(s => `<li class="${s.id === r.boardingStop ? 'boarding-stop' : s.id === r.alightingStop ? 'alighting-stop' : ''}">${s.name}${s.id === r.boardingStop ? `<span id="eta-${i}"></span>` : ''}</li>`).join('')}</div>
            `).join('') : '<p>No direct bus routes.</p>';
        };

        const toggleRouteDetails = (id, el) => {
            const details = document.getElementById(id);
            details.style.display = details.style.display === 'none' ? 'block' : 'none';
            if (details.style.display === 'block' && window.currentRoutes) {
                const i = parseInt(id.split('-')[2]), r = window.currentRoutes[i];
                if (r.busRoute || r.route) fetchETA((r.busRoute || r).route, (r.busRoute || r).direction, (r.busRoute || r).boardingStop, id, localStorage.getItem('company') || 'Citybus');
            }
        };

        const fetchETA = async (route, dir, stop, detailsId, company) => {
            const span = document.querySelector(`#${detailsId} .boarding-stop span`) || document.createElement('span');
            try {
                const url = company === 'KMB' ? `https://data.etabus.gov.hk/v1/transport/kmb/eta/${stop}/${route}/1` : `https://rt.data.gov.hk/v2/transport/citybus/eta/CTB/${stop}/${route}`;
                const { data } = await fetch(url).then(r => r.json());
                const eta = data.find(e => e.dir === (company === 'KMB' ? {outbound: 'O', inbound: 'I'}[dir] : dir)) || data.find(e => e.seq === 1 || e.eta_seq === 1);
                span.textContent = eta?.eta ? ` (ETA: ${Math.round((new Date(eta.eta) - new Date()) / 60000)} min)` : ' (No ETA data)';
            } catch {
                span.textContent = ' (ETA unavailable)';
            }
        };

        const fetchMTRToBus = async (cs, ebs, stations) => {
            const endStop = allStops.find(s => s.stop === ebs);
            if (!endStop || isNaN(parseFloat(endStop.lat)) || isNaN(parseFloat(endStop.long))) return document.getElementById('schedule').innerHTML = '<p>Invalid ending bus stop.</p>';
            const nearest = findNearestMTR(endStop, stations);
            if (!nearest.station) return document.getElementById('schedule').innerHTML = '<p>No nearby MTR station found.</p>';
            const mtrRes = await fetch('/fetch_schedule', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ currentStation: cs, destinationStation: nearest.station.value }) }).then(r => r.json()).catch(() => ({ error: 'MTR schedule unavailable' }));
            if (mtrRes.error) return document.getElementById('schedule').innerHTML = `<p>Error fetching MTR schedule: ${mtrRes.error}</p>`;
            window.currentRoutes = [{ type: 'MTR-to-Bus', mtrRoute: mtrRes.bestRoute, schedules: mtrRes.schedules, from: cs, to: nearest.station.value, walkingDistanceToMTR: nearest.distance, endStopName: endStop.name_en, estimatedTime: Math.round(mtrRes.bestRoute.route.reduce((t, l) => t + lines[l].length * 2, 0) + mtrRes.bestRoute.interchangeCount * 5 + nearest.distance / 5000 * 60) }];
            displayMixedRoutes(window.currentRoutes, 'MTR-to-Bus', cs, ebs);
        };

        const fetchBusToMTR = async (sbs, ds, stations) => {
            const startStop = allStops.find(s => s.stop === sbs);
            if (!startStop) return document.getElementById('schedule').innerHTML = '<p>Invalid starting bus stop.</p>';
            const company = new URLSearchParams(window.location.search).get('company') || 'Citybus';
            localStorage.setItem('company', company);
            const nearest = findNearestMTR(startStop, stations);
            if (!nearest.station) return document.getElementById('schedule').innerHTML = '<p>No nearby MTR station found.</p>';
            const busRoutes = allRoutes.flatMap(r => ['outbound', 'inbound'].map(d => {
                const stops = routeStopsMap[`${r.route}-${d}`] || [], sm = findNearbyStops(startStop, 500).map(s => s.stop).filter(id => stops.includes(id));
                if (!sm.length) return null;
                const cs = sm.reduce((a, id) => haversineDistance(parseFloat(startStop.lat), parseFloat(startStop.long), parseFloat(allStops.find(s => s.stop === id).lat), parseFloat(allStops.find(s => s.stop === id).long)) < a[1] ? [id, haversineDistance(parseFloat(startStop.lat), parseFloat(startStop.long), parseFloat(allStops.find(s => s.stop === id).lat), parseFloat(allStops.find(s => s.stop === id).long))] : a, ['', Infinity])[0];
                const em = stops.filter(id => stops.indexOf(id) > stops.indexOf(cs));
                if (!em.length) return null;
                const ce = em.reduce((a, id) => haversineDistance(parseFloat(nearest.station.lat), parseFloat(nearest.station.long), parseFloat(allStops.find(s => s.stop === id).lat), parseFloat(allStops.find(s => s.stop === id).long)) < a[1] ? [id, haversineDistance(parseFloat(nearest.station.lat), parseFloat(nearest.station.long), parseFloat(allStops.find(s => s.stop === id).lat), parseFloat(allStops.find(s => s.stop === id).long))] : a, ['', Infinity])[0];
                return { route: r.route, direction: d, stops: stops.map(id => ({ id, name: allStops.find(s => s.stop === id)?.name_en || `Stop ${id}` })), boardingStop: cs, alightingStop: ce, boardingDistance: haversineDistance(parseFloat(startStop.lat), parseFloat(startStop.long), parseFloat(allStops.find(s => s.stop === cs).lat), parseFloat(allStops.find(s => s.stop === cs).long)), alightingDistance: haversineDistance(parseFloat(nearest.station.lat), parseFloat(nearest.station.long), parseFloat(allStops.find(s => s.stop === ce).lat), parseFloat(allStops.find(s => s.stop === ce).long)) };
            })).filter(r => r);
            const mtrRes = await fetch('/fetch_schedule', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ currentStation: nearest.station.value, destinationStation: ds }) }).then(r => r.json()).catch(() => ({ error: 'MTR schedule unavailable' }));
            if (mtrRes.error) return document.getElementById('schedule').innerHTML = `<p>Error fetching MTR schedule: ${mtrRes.error}</p>`;
            window.currentRoutes = busRoutes.map(br => ({
                busRoute: br, mtrRoute: mtrRes.bestRoute, schedules: mtrRes.schedules, from: nearest.station.value, to: ds, walkingDistanceToMTR: nearest.distance, boardingStopName: allStops.find(s => s.stop === br.boardingStop)?.name_en || `Stop ${br.boardingStop}`, alightingStopName: allStops.find(s => s.stop === br.alightingStop)?.name_en || `Stop ${br.alightingStop}`, stopCount: br.stops.findIndex(s => s.id === br.alightingStop) - br.stops.findIndex(s => s.id === br.boardingStop), estimatedTime: Math.round((br.stops.findIndex(s => s.id === br.alightingStop) - br.stops.findIndex(s => s.id === br.boardingStop)) * 2 + nearest.distance / 5000 * 60 + mtrRes.bestRoute.route.reduce((t, l) => t + lines[l].length * 2, 0) + mtrRes.bestRoute.interchangeCount * 5)
            })).sort((a, b) => a.estimatedTime - b.estimatedTime).slice(0, 3);
            displayMixedRoutes(window.currentRoutes, 'Bus-to-MTR', sbs, ds);
        };

        const displayMixedRoutes = (routes, type, start, end) => {
            document.getElementById('schedule').innerHTML = routes.length ? `<h3>${type} Routes</h3>` + routes.map((r, i) => type === 'Bus-to-MTR' ? `
                <div class="route-option" id="route-summary-${i}" onclick="toggleRouteDetails('route-details-${i}', this)">
                    <strong>Route ${i + 1}</strong><br>Bus ${r.busRoute.route} (${r.busRoute.direction}): Walk ${Math.round(r.busRoute.boardingDistance)}m to ${r.boardingStopName}, alight at ${r.alightingStopName} (${r.stopCount} stops)<br>Walk ${Math.round(r.walkingDistanceToMTR)}m to ${getStationFullName(r.from)}<br>MTR: ${r.mtrRoute.route.map(l => lineNames[l]).join(' → ')} to ${getStationFullName(end)}<br>Estimated Time: ${r.estimatedTime} mins
                </div>
                <div class="route-details" id="route-details-${i}">
                    <h4>Bus Segment</h4><ul class="stop-list">${r.busRoute.stops.map(s => `<li class="${s.id === r.busRoute.boardingStop ? 'boarding-stop' : s.id === r.busRoute.alightingStop ? 'alighting-stop' : ''}">${s.name}${s.id === r.busRoute.boardingStop ? `<span id="eta-${i}"></span>` : ''}</li>`).join('')}</ul>
                    <p>Walk ${Math.round(r.walkingDistanceToMTR)}m to ${getStationFullName(r.from)}</p>
                    <h4>MTR Segment</h4>${r.mtrRoute.route.map(line => `<h5>${lineNames[line]}</h5><table class="schedule-table"><tr><th>Next Train (mins)</th><th>Platform</th><th>Destination</th><th>Sequence</th></tr>${(r.schedules[line]?.[lines[line].findIndex(s => s.value === r.from) < lines[line].findIndex(s => s.value === r.to) ? 'up' : 'down'] || []).slice(0, 1).map(t => `<tr><td>${Math.round((new Date(t.time) - new Date()) / 60000)}</td><td>${t.plat}</td><td>${getStationFullName(t.dest)}</td><td>${t.seq}</td></tr>`).join('') || '<tr><td colspan="4">No upcoming trains</td></tr>'}</table>`).join('')}
                </div>
            ` : `
                <div class="route-option" id="route-summary-${i}" onclick="toggleRouteDetails('route-details-${i}', this)">
                    <strong>Route ${i + 1}</strong><br>MTR: ${r.mtrRoute.route.map(l => lineNames[l]).join(' → ')}: From ${getStationFullName(r.from)} to ${getStationFullName(r.to)}<br>Then walk ${Math.round(r.walkingDistanceToMTR)}m to ${r.endStopName} (Bus Stop)<br>Estimated Time: ${r.estimatedTime} mins
                </div>
                <div class="route-details" id="route-details-${i}">
                    <h4>MTR Segment</h4>${r.mtrRoute.route.map(line => `<h5>${lineNames[line]}</h5><table class="schedule-table"><tr><th>Next Train (mins)</th><th>Platform</th><th>Destination</th><th>Sequence</th></tr>${(r.schedules[line]?.[lines[line].findIndex(s => s.value === r.from) < lines[line].findIndex(s => s.value === r.to) ? 'up' : 'down'] || []).slice(0, 1).map(t => `<tr><td>${Math.round((new Date(t.time) - new Date()) / 60000)}</td><td>${t.plat}</td><td>${getStationFullName(t.dest)}</td><td>${t.seq}</td></tr>`).join('') || '<tr><td colspan="4">No upcoming trains</td></tr>'}</table>`).join('')}
                    <p>Then walk ${Math.round(r.walkingDistanceToMTR)}m to ${r.endStopName} (Bus Stop)</p>
                </div>
            `).join('') : `<p>No ${type} routes found.</p>`;
        };
    </script>
</body>
</html>
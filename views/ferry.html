<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferry - Route Planner</title>
    <link rel="stylesheet" href="navbar.css">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-image: url("hk_ferry.png");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            flex-direction: column;
        }
        .ferry-container {
            margin-left: 170px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .company-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .company-button {
            background-color: #007bff;
            color: #fff;
            padding: 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            text-align: center;
            font-size: 1.2em;
            transition: background-color 0.3s, transform 0.2s;
        }
        .company-button:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }
        .route-list {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
            padding-left: 20px;
        }
        .route-list.active {
            display: flex;
        }
        .route-button {
            background-color: #28a745;
            color: #fff;
            padding: 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            text-align: left;
            transition: background-color 0.3s;
        }
        .route-button:hover {
            background-color: #218838;
        }
        .route-details {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .route-details.active {
            display: block;
            opacity: 1;
        }
        .details-section {
            margin-bottom: 20px;
        }
        .details-section h3 {
            color: #333;
            margin-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f5f5f5;
        }
        .eta-highlight {
            font-weight: bold;
            color: #007bff;
        }
        .loading {
            text-align: center;
            color: #777;
        }
        .error {
            color: #d9534f;
        }
    </style>
</head>
<body>
    <script src="navbar.js"></script>
    <div class="ferry-container">
        <h1>Ferry Routes</h1>
        <div class="company-list" id="companyList"></div>
        <div class="route-details" id="routeDetails">
            <h2 id="routeTitle"></h2>
            <div class="details-section" id="timetable-section">
                <h3>Upcoming Timetable</h3>
                <table id="timetable"></table>
            </div>
            <div class="details-section" id="eta-section">
                <h3>Next Ferry</h3>
                <p id="eta"></p>
            </div>
            <div class="details-section" id="fares-section">
                <h3>Fares</h3>
                <table id="fares"></table>
            </div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const companyList = document.getElementById('companyList');
        const routeDetails = document.getElementById('routeDetails');
        const routeTitle = document.getElementById('routeTitle');
        const timetable = document.getElementById('timetable');
        const eta = document.getElementById('eta');
        const fares = document.getElementById('fares');

        // Fallback timetable data for Central ↔ Sok Kwu Wan (route_id: 1)
        const fallbackTimetableCSV = `Time,Direction,Days\n07:20,Outbound,Mon-Sat\n08:35,Outbound,Mon-Sat\n10:20,Outbound,Mon-Sat\n06:45,Inbound,Mon-Sat\n08:00,Inbound,Mon-Sat\n09:35,Inbound,Mon-Sat`;

        // Ferry company data
        const ferryCompanies = [
            {
                name: "Hong Kong and Kowloon Ferry (HKKF)",
                apiBase: "https://www.hkkfeta.com/opendata",
                hasTimetable: true,
                hasFares: true,
                mockRoutes: [
                    { route_id: 1, route_name_en: "Central ↔ Sok Kwu Wan", origin_en: "Central", destination_en: "Sok Kwu Wan" },
                    { route_id: 2, route_name_en: "Central ↔ Yung Shue Wan", origin_en: "Central", destination_en: "Yung Shue Wan" },
                    { route_id: 3, route_name_en: "Central ↔ Peng Chau", origin_en: "Central", destination_en: "Peng Chau" },
                    { route_id: 4, route_name_en: "Peng Chau ↔ Hei Ling Chau", origin_en: "Peng Chau", destination_en: "Hei Ling Chau" }
                ]
            },
        ];

        // Display company buttons
        ferryCompanies.forEach((company, index) => {
            const companyButton = document.createElement('button');
            companyButton.classList.add('company-button');
            companyButton.textContent = company.name;
            const routeList = document.createElement('div');
            routeList.classList.add('route-list');
            routeList.id = `route-list-${index}`;

            companyButton.addEventListener('click', () => {
                const isActive = routeList.classList.contains('active');
                document.querySelectorAll('.route-list').forEach(list => list.classList.remove('active'));
                routeDetails.classList.remove('active');
                if (!isActive) routeList.classList.add('active');
            });

            let routes = company.mockRoutes;
            if (company.name === "Hong Kong and Kowloon Ferry (HKKF)") {
                fetch(`${company.apiBase}/route`)
                    .then(response => {
                        if (!response.ok) throw new Error(`Route fetch failed: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        routes = data.data;
                        displayRoutes(company, routes, routeList);
                    })
                    .catch(error => {
                        console.error('Error fetching routes:', error);
                        displayRoutes(company, routes, routeList); // Use mock routes as fallback
                    });
            } else {
                displayRoutes(company, routes, routeList);
            }

            companyList.appendChild(companyButton);
            companyList.appendChild(routeList);
        });

        // Display routes as buttons
        function displayRoutes(company, routes, routeList) {
            routeList.innerHTML = '';
            routes.forEach(route => {
                const routeButton = document.createElement('button');
                routeButton.classList.add('route-button');
                routeButton.textContent = route.route_name_en;
                routeButton.addEventListener('click', () => showRouteDetails(company, route));
                routeList.appendChild(routeButton);
            });
        }

        // Show route details
        function showRouteDetails(company, route) {
            routeTitle.textContent = `${route.route_name_en} (${company.name})`;
            routeDetails.classList.add('active');

            const timetableSection = document.getElementById('timetable-section');
            const etaSection = document.getElementById('eta-section');
            const faresSection = document.getElementById('fares-section');

            // Always show ETA section
            etaSection.style.display = 'block';
            eta.innerHTML = '<div class="loading">Loading ETA...</div>';

            // Timetable section
            if (company.hasTimetable) {
                timetableSection.style.display = 'block';
                timetable.innerHTML = '<div class="loading">Loading timetable...</div>';
                fetch(`${company.apiBase}/eta/${route.route_id}/outbound`)
    .then(response => {
        if (!response.ok) throw new Error(`ETA fetch failed: ${response.status}`);
        return response.json();
    })
    .then(data => renderETA(data.data, route.origin_en, route.destination_en))
    .catch(error => {
        console.error('ETA fetch error:', error);
        eta.innerHTML = '<p class="error">Real-time ETA unavailable.</p>';
    })
                    .then(csv => renderTimetable(csv, route.origin_en, route.destination_en))
                    .catch(error => {
                        console.error('Timetable fetch error:', error);
                        if (route.route_id === 1) { // Fallback for Sok Kwu Wan
                            renderTimetable(fallbackTimetableCSV, route.origin_en, route.destination_en);
                            timetable.innerHTML += '<p class="error">Using cached data due to API failure.</p>';
                        } else {
                            timetable.innerHTML = '<p class="error">Error fetching timetable.</p>';
                        }
                    });
            } else {
                timetableSection.style.display = 'none';
            }

            // Fares section
            if (company.hasFares) {
                faresSection.style.display = 'block';
                fares.innerHTML = '<div class="loading">Loading fares...</div>';
                fetch(`${company.apiBase}/fare_table/${route.route_id}`)
                    .then(response => {
                        if (!response.ok) throw new Error(`Fares fetch failed: ${response.status}`);
                        return response.text();
                    })
                    .then(csv => renderFares(csv))
                    .catch(error => {
                        console.error('Fares fetch error:', error);
                        fares.innerHTML = '<p class="error">Error fetching fares.</p>';
                    });
            } else {
                faresSection.style.display = 'none';
            }

            // Fetch ETA with fallback
            if (company.name === "Hong Kong and Kowloon Ferry (HKKF)") {
                fetch(`${company.apiBase}/eta/${route.route_id}/outbound`)
                    .then(response => {
                        if (!response.ok) throw new Error(`ETA fetch failed: ${response.status}`);
                        return response.json();
                    })
                    .then(data => renderETA(data.data, route.origin_en, route.destination_en))
                    .catch(error => {
                        console.error('ETA fetch error:', error);
                        if (route.route_id === 1) { // Fallback for Sok Kwu Wan
                            renderFallbackETA(route.origin_en, route.destination_en);
                        } else {
                            eta.innerHTML = `<p class="error">Real-time ETA unavailable for ${route.destination_en}.</p>`;
                        }
                    });
            } else {
                eta.innerHTML = '<p>Real-time ETA unavailable.</p>';
            }
        }
        function renderTimetable(csv, origin, destination) {
            timetable.innerHTML = '';
            const rows = csv.split('\n').map(row => row.split(','));
            const headers = ['Time', 'Direction', 'Days'];
            const body = rows.slice(1).map(row => row.slice(0, 3));
        
            if (body.length === 0 || body.every(row => row.length < 3)) {
                timetable.innerHTML = '<p class="error">Timetable data unavailable.</p>';
                return;
            }
        
            const thead = document.createElement('thead');
            const trHead = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                trHead.appendChild(th);
            });
            thead.appendChild(trHead);
            timetable.appendChild(thead);
        
            const tbody = document.createElement('tbody');
            body.forEach(row => {
                if (row.length >= 3) {
                    const tr = document.createElement('tr');
                    const direction = row[1].includes("To") ? row[1] : row[1] === "Outbound" ? `To ${destination}` : `From ${destination}`;
                    [row[0], direction, row[2]].forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                }
            });
            timetable.appendChild(tbody);
        }
        
        function renderETA(etaData, origin, destination) {
            const nextETA = etaData[0];
            if (nextETA && nextETA.ETA) {
                const time = nextETA.ETA.split('T')[1].slice(0, 5);
                const direction = nextETA.direction === "outbound" ? `to ${destination}` : `from ${destination}`;
                eta.innerHTML = `Next Ferry: <span class="eta-highlight">${time}</span> ${direction}`;
            } else {
                eta.innerHTML = '<p>No upcoming ferries for this route.</p>';
            }
        }
        
        // In showRouteDetails, update the ETA fetch:
        fetch(`${company.apiBase}/eta/${route.route_id}/outbound`)
            .then(response => {
                if (!response.ok) throw new Error(`ETA fetch failed: ${response.status}`);
                return response.json();
            })
            .then(data => renderETA(data.data, route.origin_en, route.destination_en))
            .catch(error => {
                console.error('ETA fetch error:', error);
                eta.innerHTML = '<p class="error">Real-time ETA unavailable.</p>';
            });

        // Fallback ETA calculation
        function renderFallbackETA(origin, destination) {
            const now = new Date();
            const hkTime = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Hong_Kong" }));
            const hours = hkTime.getHours();
            const minutes = hkTime.getMinutes();
            const currentTime = hours * 60 + minutes;

            // Simplified fallback timetable for Sok Kwu Wan (outbound only)
            const outboundTimes = [
                { time: "07:20", minutes: 7 * 60 + 20 },
                { time: "08:35", minutes: 8 * 60 + 35 },
                { time: "10:20", minutes: 10 * 60 + 20 },
                { time: "11:50", minutes: 11 * 60 + 50 },
                { time: "13:50", minutes: 13 * 60 + 50 },
                { time: "15:20", minutes: 15 * 60 + 20 },
                { time: "16:50", minutes: 16 * 60 + 50 },
                { time: "18:45", minutes: 18 * 60 + 45 },
                { time: "20:20", minutes: 20 * 60 + 20 },
                { time: "21:50", minutes: 21 * 60 + 50 },
                { time: "23:30", minutes: 23 * 60 + 30 }
            ];

            const nextFerry = outboundTimes.find(t => t.minutes > currentTime) || outboundTimes[0];
            eta.innerHTML = `Next Ferry (estimated): <span class="eta-highlight">${nextFerry.time}</span> to ${destination} <p class="error">Real-time ETA unavailable, using estimate.</p>`;
        }

        // Render fares
        function renderFares(csv) {
            fares.innerHTML = '';
            const rows = csv.split('\n').map(row => row.split(','));
            const headers = rows[0];
            const body = rows.slice(1);

            const thead = document.createElement('thead');
            const trHead = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header === "Day" ? "Type" : header;
                trHead.appendChild(th);
            });
            thead.appendChild(trHead);
            fares.appendChild(thead);

            const tbody = document.createElement('tbody');
            body.forEach(row => {
                const tr = document.createElement('tr');
                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            fares.appendChild(tbody);
        }
    });
    </script>
</body>
</html>